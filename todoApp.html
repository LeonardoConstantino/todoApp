<!DOCTYPE html>
<html lang="pt-BR">
  <!-- [Head e estilos anteriores permanecem os mesmos at√© o .task-card] -->
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lista de Tarefas</title>
    <style>
      @import url('https://fonts.googleapis.com/css?family=Noto+Sans+Buginese:400,700');

      :root {
        --bg-primary: #ffffff;
        --bg-secondary: #f5f5f5;
        --text-primary: #333333;
        --text-secondary: #666666;
        --text-tertiary: #999999;
        --accent: #4a90e2;
        --border: #e0e0e0;
        --success: #4caf50;
        --warning: #ff9800;
        --danger: #f44336;
        --card-bg: #ffffff;
        --shadow: rgba(0, 0, 0, 0.1);

        --spacing-xp: calc(var(--spacing) / 4 * 1); /*0.25rem   4px*/
        --spacing-pp: calc(var(--spacing) / 4 * 2); /*0.5rem    8px*/
        --spacing-p: calc(var(--spacing) / 4 * 3); /*0.75rem   12px*/
        --spacing: 1rem; /*1rem      16px*/
        --spacing-g: calc(var(--spacing) * 4 / 3); /*1.33rem   21.33px*/
        --spacing-gg: calc(var(--spacing) * 4 / 2); /*2rem      32px*/
        --spacing-xg: calc(var(--spacing) * 4 / 1); /*4rem      64px*/

        --border-radius: 0.3125rem; /*5px*/

        --animation-duration: 0.3s;
      }
      body {
        font-family: 'Noto Sans Buginese', sans-serif;
        font-weight: 400;
      }

      h1,
      h2,
      h3,
      h4,
      h5 {
        font-family: 'Noto Sans Buginese', sans-serif;
        font-weight: 700;
      }
      html {
        font-size: 100%;
      } /* 16px */
      /* Tamanhos de fonte para diferentes n√≠veis de cabe√ßalho */
      h1 {
        font-size: 2.489rem; /* ~40px */
      }
      h2 {
        font-size: 2.074rem; /* ~33px */
      }
      h3 {
        font-size: 1.728rem; /* ~28px */
      }
      h4 {
        font-size: 1.44rem; /* ~23px */
      }
      h5 {
        font-size: 1.2rem; /* ~19px */
      }

      /* Tamanho de fonte para elementos pequenos */
      small {
        font-size: 0.833rem; /* ~13px */
      }

      [data-theme='dark'] {
        --bg-primary: #1a1a1a;
        --bg-secondary: #2d2d2d;
        --text-primary: #ffffff;
        --text-secondary: #b3b3b3;
        --text-tertiary: #808080;
        --accent: #64b5f6;
        --border: #404040;
        --success: #81c784;
        --warning: #ffb74d;
        --danger: #e57373;
        --card-bg: #2d2d2d;
        --shadow: rgba(0, 0, 0, 0.3);
      }

      * {
        scroll-behavior: smooth;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        transition: background-color var(--animation-duration),
          color var(--animation-duration);
        /* border: red 1px solid; */
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      body {
        background-color: var(--bg-primary);
        color: var(--text-primary);
        line-height: 1.6;
        padding: var(--spacing-g);
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-g);
        padding-bottom: var(--spacing-p);
        border-bottom: 2px solid var(--border);
      }

      .theme-toggle {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        color: var(--text-primary);
        padding: var(--spacing-pp) var(--spacing);
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: var(--animation-duration);
      }

      .theme-toggle:hover {
        background: var(--accent);
        color: white;
      }

      .input-section {
        margin-bottom: var(--spacing-gg);
      }

      .input-group {
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-p);
        margin-bottom: var(--spacing-p);
        align-items: flex-start;
      }

      textarea {
        /* flex: 1 1 0; */
        width: 100%;
        padding: var(--spacing-p);
        border: 1px solid var(--border);
        border-radius: var(--border-radius);
        background: var(--bg-secondary);
        color: var(--text-primary);
        min-height: var(--spacing-gg);
        resize: vertical;
        transition: var(--animation-duration);
      }

      textarea:focus {
        outline: none;
        border-color: var(--accent);
        min-height: 100px;
      }

      select {
        padding: var(--spacing-pp) var(--spacing-p);
        border: 1px solid var(--border);
        border-radius: var(--border-radius);
        background: var(--bg-secondary);
        color: var(--text-primary);
        width: auto;
        min-width: 90px;
      }

      button {
        padding: var(--spacing-pp) var(--spacing-p);
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        background: var(--accent);
        color: white;
        transition: var(--animation-duration);
      }

      button:hover {
        opacity: 0.9;
      }

      .filters {
        display: flex;
        gap: var(--spacing-p);
        margin-bottom: var(--spacing-p);
      }

      .task-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-p);
      }

      .task-card {
        background: var(--card-bg);
        padding: var(--spacing) var(--spacing-gg);
        border-radius: var(--border-radius);
        box-shadow: 0 2px 4px var(--shadow);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-p);
      }

      .task-header {
        display: flex;
        align-items: center;
        gap: var(--spacing-p);
      }

      /* .task-wrapper {
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: var(--spacing-p);
        margin: calc(-1 * var(--spacing-p));
      } */

      .task-wrapper input[type='checkbox'] {
        width: var(--spacing);
        height: var(--spacing);
        cursor: pointer;
      }

      .task-title {
        flex: 1;
        font-size: 1.728rem;
        font-weight: 500;
        color: var(--text-primary);
      }

      .task-completed .task-title {
        text-decoration: line-through;
        color: var(--text-tertiary);
      }

      .task-priority {
        padding: var(--spacing-xp) var(--spacing-pp);
        border-radius: var(--border-radius);
        font-size: 0.8em;
      }

      .priority-high {
        background: var(--danger);
        color: white;
      }

      .priority-medium {
        background: var(--warning);
        color: white;
      }

      .priority-low {
        background: var(--success);
        color: white;
      }

      .task-dates {
        font-size: 0.85em;
        color: var(--text-tertiary);
        /* margin-left: 0; */
        line-height: 1.4;
      }

      .task-actions {
        display: flex;
        gap: 10px;
        /* margin-left: 36px; */
      }

      .stats {
        font-size: 0.9em;
        color: var(--text-secondary);
        margin-bottom: var(--spacing);
      }

      @media (max-width: 600px) {
        :root {
          --spacing: 0.65rem;
        }

        html {
          font-size: 75%;
        }

        /* .input-group {
          flex-direction: column;
        } */

        .filters {
          flex-wrap: wrap;
        }
      }
    </style>
  </head>
  <body>
    <!-- [O resto do HTML permanece exatamente o mesmo] -->
    <div class="container">
      <div class="header">
        <h1>Lista de Tarefas</h1>
        <button class="theme-toggle" data-click="toggleTheme">
          üåì Alternar Tema
        </button>
      </div>

      <div class="stats" id="stats">Carregando estat√≠sticas...</div>

      <div class="input-section">
        <div class="input-group">
          <textarea
            id="taskInput"
            placeholder="Digite suas tarefas (uma por linha)"
          ></textarea>
          <div class="input-group-actions">
            <select id="prioritySelect">
              <option value="low">Baixa</option>
              <option value="medium">M√©dia</option>
              <option value="high">Alta</option>
            </select>
            <button data-click="addTasks">Adicionar</button>
          </div>
        </div>
      </div>

      <div class="filters">
        <select id="statusFilter" data-change="applyFilters">
          <option value="all">Todas</option>
          <option value="pending">Pendentes</option>
          <option value="completed">Conclu√≠das</option>
        </select>
        <select id="priorityFilter" data-change="applyFilters">
          <option value="all">Todas Prioridades</option>
          <option value="high">Alta</option>
          <option value="medium">M√©dia</option>
          <option value="low">Baixa</option>
        </select>
      </div>

      <div id="taskList" class="task-list">
        <!-- Tarefas ser√£o inseridas aqui -->
      </div>
    </div>

    <script>
      // Estado inicial
      let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
      const theme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', theme);
      const container = document.body;
      const allClickedElement = document.querySelectorAll('[data-click]');
      const allChangeElement = document.querySelectorAll('[data-change]');

      function formatDate(date) {
        return new Date(date).toLocaleString('pt-BR');
      }

      function getTimeDiff(start, end) {
        const diff = end - start;
        const minutes = Math.floor(diff / (1000 * 60));
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (days > 0) return `${days} dia(s)`;
        if (hours > 0) return `${hours} hora(s)`;
        return `${minutes} minuto(s)`;
      }

      const EventDelegator = {
        eventHandlers: new Map(),
        initializedContainers: new Set(),
        handlerId: 0,

        init(container = document.body) {
          if (this.initializedContainers.has(container)) return;

          const delegatedEvents = [
            'click',
            'submit',
            'change',
            'input',
            'keyup',
            'keydown',
            'mouseenter',
            'mouseleave',
            'focus',
            'blur',
          ];

          delegatedEvents.forEach((eventType) => {
            container.addEventListener(
              eventType,
              (event) => {
                let target = event.target;

                while (target && target !== container) {
                  const handlerId = target.dataset.handlerId;
                  if (handlerId) {
                    const handlers = this.eventHandlers.get(handlerId);
                    if (handlers && handlers[eventType]) {
                      handlers[eventType](event);
                      if (event.cancelBubble) break;
                    }
                  }
                  target = target.parentElement;
                }
              },
              { passive: ['scroll', 'touchmove'].includes(eventType) }
            );
          });

          this.initializedContainers.add(container);
        },

        registerEventHandlers(element, listeners) {
          const handlerId = `h${++this.handlerId}`;
          const handlers = {};
          Object.entries(listeners).forEach(([eventName, handler]) => {
            const eventType = eventName.replace(/^on/i, '').toLowerCase();
            handlers[eventType] = handler;
          });
          this.eventHandlers.set(handlerId, handlers);
          element.dataset.handlerId = handlerId;
          return handlerId;
        },

        removeEventHandlers(handlerId) {
          this.eventHandlers.delete(handlerId);
        },

        cleanup(element) {
          const handlerId = element.dataset.handlerId;
          if (handlerId) {
            this.removeEventHandlers(handlerId);
            delete element.dataset.handlerId;
          }

          element.querySelectorAll('[data-handler-id]').forEach((child) => {
            const childHandlerId = child.dataset.handlerId;
            if (childHandlerId) {
              this.removeEventHandlers(childHandlerId);
              delete child.dataset.handlerId;
            }
          });
        },
      };

      EventDelegator.init(container);

      const func = {
        toggleTheme: () => {
          const currentTheme =
            document.documentElement.getAttribute('data-theme');
          const newTheme = currentTheme === 'light' ? 'dark' : 'light';
          document.documentElement.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);
        },
        addTasks: () => {
          const input = document.getElementById('taskInput');
          const priority = document.getElementById('prioritySelect').value;
          const taskLines = input.value.trim().split('\n');

          taskLines.forEach((title) => {
            if (title.trim()) {
              const task = {
                id: Date.now() + Math.random(),
                title: title.trim(),
                priority,
                completed: false,
                createdAt: new Date().toISOString(),
                completedAt: null,
              };
              tasks.push(task);
            }
          });

          saveTasks();
          input.value = '';
          renderTasks();
        },
        applyFilters: () => {
          renderTasks();
        },
      };

      const toggleTask = (id) => {
        const task = tasks.find((t) => t.id === id);
        if (task) {
          task.completed = !task.completed;
          task.completedAt = task.completed ? new Date().toISOString() : null;
          saveTasks();
          renderTasks();
        }
      };

      const deleteTask = (id) => {
        console.log(EventDelegator.eventHandlers);
        tasks = tasks.filter((t) => t.id !== id);
        saveTasks();
        renderTasks();
        console.log(EventDelegator.eventHandlers);
      };

      const saveTasks = () => {
        localStorage.setItem('tasks', JSON.stringify(tasks));
        updateStats();
        // console.log(tasks)
      };

      const getFilteredTasks = () => {
        const statusFilter = document.getElementById('statusFilter').value;
        const priorityFilter = document.getElementById('priorityFilter').value;

        return tasks.filter((task) => {
          const statusMatch =
            statusFilter === 'all' ||
            (statusFilter === 'completed' && task.completed) ||
            (statusFilter === 'pending' && !task.completed);
          const priorityMatch =
            priorityFilter === 'all' || task.priority === priorityFilter;
          return statusMatch && priorityMatch;
        });
      };

      const criarElementoHTML = (str) => {
        // Criar o elemento HTML
        const el = document.createElement('div');
        el.innerHTML = str.toString();

        // Validar a string de entrada para garantir que seja uma marca√ß√£o HTML segura
        const validacaoRegExp = /^<([a-z]+)([^<]+)*(?:>(.*)<\/\1>|\s+\/>)$/i;
        if (!validacaoRegExp.test(str)) {
          console.error('A string fornecida n√£o √© uma marca√ß√£o HTML v√°lida.');
          el.innerHTML = '';
          return el;
        }

        try {
          // Retornar o primeiro elemento filho
          return el.firstElementChild;
        } catch (error) {
          console.error(
            'N√£o foi poss√≠vel criar o elemento HTML. Verifique se a marca√ß√£o fornecida √© v√°lida.'
          );
          el.innerHTML = '';
          return el;
        }
      };

      const renderTasks = () => {
        const taskList = document.getElementById('taskList');
        const filteredTasks = getFilteredTasks();

        EventDelegator.cleanup(taskList);
        taskList.innerHTML = '';

        const taskListContainer = document.createDocumentFragment();

        filteredTasks.forEach(
          ({ id, title, priority, completed, createdAt, completedAt }) => {
            const divTaskCard = criarElementoHTML(
              `<div class="task-card ${
                completed ? 'task-completed' : ''
              }"></div>`
            );
            const label = criarElementoHTML(
              `<label class="task-wrapper"></label>`
            );
            const taskHeader = criarElementoHTML(
              `<div class="task-header"></div>`
            );
            const inputCheckbox = criarElementoHTML(
              `<input type="checkbox" ${completed ? 'checked' : ''}></input>`
            );
            EventDelegator.registerEventHandlers(inputCheckbox, {
              change: () => {
                toggleTask(id);
              },
            });
            const taskTitle = criarElementoHTML(
              `<span class="task-title">${title}</span>`
            );
            const taskPriority = criarElementoHTML(
              `<span class="task-priority priority-${priority}"> ${
                priority.charAt(0).toUpperCase() + priority.slice(1)
              }</span>`
            );

            const taskDates = document.createElement('div');
            taskDates.className = 'task-dates';
            taskDates.innerHTML = `Criada: ${formatDate(createdAt)} ${
              completed ? `<br>Conclu√≠da: ${formatDate(completedAt)}` : ''
            }<br>Tempo: ${
              completed
                ? getTimeDiff(new Date(createdAt), new Date(completedAt))
                : getTimeDiff(new Date(createdAt), new Date())
            }`;
            const taskActions = criarElementoHTML(
              `<div class="task-actions"></div>`
            );
            const deleteButton = criarElementoHTML(
              `<button class="delete-button">Excluir</button>`
            );
            EventDelegator.registerEventHandlers(deleteButton, {
              click: () => {
                deleteTask(id);
              },
            });
            taskHeader.appendChild(inputCheckbox);
            taskHeader.appendChild(taskTitle);
            taskHeader.appendChild(taskPriority);

            label.appendChild(taskHeader);
            label.appendChild(taskDates);

            taskActions.appendChild(deleteButton);

            divTaskCard.appendChild(label);
            divTaskCard.appendChild(taskActions);

            taskListContainer.appendChild(divTaskCard);
          }
        );

        taskList.appendChild(taskListContainer);
      };

      const updateStats = () => {
        const total = tasks.length;
        const completed = tasks.filter((t) => t.completed).length;
        const pending = total - completed;

        document.getElementById(
          'stats'
        ).innerHTML = `Total: ${total} | Pendentes: ${pending} | Conclu√≠das: ${completed}`;
      };

      renderTasks();
      updateStats();

      allChangeElement.forEach((element) => {
        EventDelegator.registerEventHandlers(element, {
          change: func[element.dataset.change],
        });
      });

      allClickedElement.forEach((element) => {
        EventDelegator.registerEventHandlers(element, {
          onclick: func[element.dataset.click],
        });
      });
    </script>
  </body>
</html>
